# 操作系统 内存管理

## 基础知识

内存是用于存放数据的硬件。程序执行前需要先放到内存中才能被CPU处理。

在多道程序环境下，系统中会有多个程序并发执行，即会有不同的程序数据同时放到内存中，需要区分各个程序的数据放在内存中的位置--给内存的存储单元编地址：1. 按字节编址，每个存储单元大小为1字节；2. 按字长编址，每个存储单元大小为1字长，具体大小视计算机而定（32位、64位）。

进程的运行时，对CPU来说看到的都是01二进制指令，每一个指令会有一个操作码，告诉CPU接下来要进行的动作，不同的指令会对应一些不同的参数，比如数据在内存中的存放位置。编译时生成的指令中一般是使用逻辑地址（相对地址）。

<img src="https://i.loli.net/2021/06/28/zraDSQ3xh1PekCF.png" alt="写程序到程序运行" style="zoom: 67%;" />

装入的三种方式（完成逻辑地址到物理地址的转换）：

1. 绝对装入

   在编译时，如果知道程序将放到内存中的哪个位置，编译程序将产生绝对地址的目标代码，装入程序按照装入模块中的地址，将程序和数据放入内存。即编译、链接后得到的装入模块的指令直接使用了绝对地址。

   一般适合单道程序环境，内存中同一时刻只有一个程序。

2. 静态重定位

   可重定位装入。编译、链接后的装入模块的地址都是从0开始的，指令中使用的地址、数据存放的地址相对于其实地址而言的逻辑地址。可根据内存的当前情况，将装入模块装入到内存的适当位置，装入时对地址进程“重定位”，将逻辑地址转换为物理地址（地址变换是在装入时一次完成的）

   静态重定位的特点是在一个作业装入内存时，必须分配其要求的全部内存空间，如果没有足够的内存，就不能装入该作业。作业一旦进入内存后，在运行期间也不能再移动，也不能再申请内存空间。

3. 动态重定位

   动态运行时装入。编译、链接后的装入模块的地址都是从0开始的。装入程序把装入模块装入内存后，并不会立即把逻辑地址转换为物理地址，而是把地址转换推迟到程序真正要执行时才进行。银日装入内存后所有的地址依然为逻辑地址。这种方式需要一个重定位寄存器支持，用于存放装入模块存放的起始位置。

   该方法允许程序再内存中发生移动。并且可以将程序分哦到不连续的存储区中；在程序运行前只需装入它的部分代码即可投入运行，然后在程序运行期间，根据需要动态申请分配内存；便于程序段的共享，可以向用户提供一个比存储空间大的多的地址空间。

链接的三种方式：

1. 静态链接
2. 装入时动态链接
3. 运行时动态链接

## 内存管理

操作系统要怎么记录哪些内存区域已经被分配出去了，又有哪些是空闲的；很多位置都可以放新的进程，应该放在哪里；当进程运行结束后，如何将进程占用的内存空间回收？即操作系统负责内存空间的分配与回收。

GTA大小超过60G，电脑内存才8G，为什么能顺利运行？即操作系统需要提供某种技术从逻辑上对内存空间进行扩充（虚拟技术）。

地址重定位（逻辑地址到物理地址的转换）应该由操作系统负责，保证程序员在写程序时不需要关注物理内存的实际情况。即操作系统需要提供地址转换功能即是三种装入方式。

操作系统需要提供内存保护功能，保证各进程在各自存储空间内运行，互不干扰。<br>两种方法：1. 在CPU设置一对上、下限寄存器，存放某个进程的上、下限地址。进程的指令要访问某个地址时，CPU检查是否越界；2. 采用重定位寄存器（基址寄存器）和界地址寄存器（限长寄存器）进行越界检查、重定位寄存器中存放的是进程的起始物理地址。界地址寄存器存放的是进程的最大逻辑地址。

![](https://i.loli.net/2021/06/28/PeUDTpz8xfKM9FX.png)

