# 操作系统 概述

一些简单的记录

### OS的运行机制和体系结构

**运行机制**

1. 两种指令：特权指令（高权限，如内存清零指令，不允许用户程序使用），非特权指令（加减乘除等普通的运算指令）
2. 两种处理机状态：用户态；核心态。（用程序状态寄存器中的某些标志位来标识当前处理器处于什么状态）
   * 用户态：只能执行非特权指令
   * 核心态：特权指令、非特权指令都可执行
3. 两种程序：内核程序；应用程序
   * 内核程序：操作系统的内核程序是系统的管理者，既可以执行特权指令，也可以执行非特权指令，运行在核心态
   * 应用程序：为了保证系统能安全运行，普通应用程序只能执行非特权指令，运行的用户态



**操作系统内核**

内核是计算机上的配置的底层软件，是操作系统最基本最核心的部分：

![](https://i.loli.net/2021/07/01/txhoD2qYpkyBz3g.png)

* 时钟管理：实现计时功能

* 中断处理：负责实现中断机制

* 原语：是一种特殊的程序，其运行具有原子性，只能一气呵成，不可中断，运行时间短、调用频繁。处于操作系统的最底层，最接近硬件。

* 对系统资源进行管理：1. 进程管理；2. 存储器管理；3. 设备管理

  > 有些操作系统不把对系统资源的管理归为内核功能。即不同的操作系统对内核功能划分可能不一样。

大内核：将操作系统的主要功能模块都作为系统内核，运行在核心态。优点：高性能。缺点：内核代码庞大、结构混乱、难以维护。

微内核：只保留最基本的功能模块（始终管理、中断处理、原语）。优点：内核功能少，结构清晰，方便维护。缺点：需要频繁的在核心态和用户态之间切换，性能低。



### 中断和异常

**中断的作用**：“中断”会使CPU由用户态变为内核态，使操作系统重新夺回对CPU的控制权，是让操作系统内核夺回CPU使用权的唯一途径。

> 如果没有“中断”机制，那么一旦应用程序上CPU运行，CPU就会一直运行这个应用程序

内核态 → 用户态：执行一条特权指令——**修改PSW的标志位为“用户态”**，这个动作意味着操作系统将主动让出CPU使用权

用户态 → 内核态：由“中断”引发，**硬件自动完成变态过程**，触发中断信号意味着操作系统将强行夺回CPU的使用权

**中断的类型**：

* 内中断：中断信号来源于CPU内部，一般和当前执行的指令有关。

  * 试图在用户态下执行特权指令

  * 执行除法指令时发现除数为 0 **若当前执行的指令是非法的，则会引发一个中断信号**

  * 有时候应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令——`陷入指令`，该指令会引发一个内部中断信号

    > 执行“陷入指令”，意味着应用程序主动地将CPU控制权还给操作系统内核。“系统调用”就是通过陷入指令完成的

  * ......

* 外中断：中断信号来源于CPU外部，一般与当前执行的指令无关。每一条指令执行结束时，CPU都会例行检查是否有外中断信号。

  * 时钟中断——由时钟部件发来的中断信号（时间片到了）
  * I/O中断——由输入 / 输出设备发来的中断信号

  ![](https://i.loli.net/2021/07/01/KLtTdnWpbN8msjS.png)

**中断机制的基本原理**

不同的中断信号，需要用不同的中断处理程序来处理。当CPU检测到中断信号后，会根据中断信号的类型去查询**“中断向量表”**，以此来找到相应的中断处理程序在内存中的存放位置。

中断处理的程序一定是内核程序，需要运行在“核心态”。



### 系统调用

![](https://i.loli.net/2021/07/01/7F6hNszGMwrWOJ5.png)

操作系统作为用户和计算机硬件之间的接口，需要向上提供一些简单易用的服务。主要包括命令接口和程序接口。其中**程序接口由一组系统调用组成**。

“系统调用”是操作系统提供给应用程序（程序员 / 编程人员）使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求**获得操作系统内核的服务**。

**为什么系统调用是必须的？**

生活场景：去学校打印店打印论文，你按下了WPS 的“打印”选项，打印机开始工作。你的论文打印到一半时，另一位同学按下了Word 的“打印”按钮，开始打印他自己的论文。

思考：如果两个进程可以随意地、并发地共享打印机资源，会发生什么情况？

两个进程并发运行，打印机设备交替地收到WPS 和Word 两个进程发来的打印请求，结果两篇论文的内容混杂在一起了…

解决方法：由操作系统内核对共享资源进行统一的管理，并向上提供“系统调用”，用户进程想要使用打印机这种共享资源，只能通过系统调用向操作系统内核发出请求。内核会对各个请求进行协调处理。

**什么功能要用到系统调用**

应用程序通过系统调用请求操作系统的服务。而系统中的各种共享资源都由操作系统内核统一掌管，因此**凡是与共享资源有关的操作（如存储分配、I/O操作、文件管理等），都必须通过系统调用的方式向操作系统内核提出服务请求**，由操作系统内核代为完成。这样可以保证系统的稳定性和安全性，防止用户进行非法操作。
![](https://i.loli.net/2021/07/01/regKBpUa5sV37lz.png)

>  应用程序想请求操作系统内核的服务，此时会执行一条特殊的指令——`陷入指令`，
>
> 1. 陷入指令是在用户态执行的，执行陷入指令之后立即引发一个内中断，使CPU进入核心态
> 2. 发出系统调用请求是在用户态，而对系统调用的相应处理在核心态下进行
> 3. 陷入指令是唯一一个不能再核心态下执行的指令

